# 🎒 西瓜时钟 — 仓库（瓜棚）与合成系统设计 v1

> 初版确认：2026-02-11
> v2 更新：2026-02-11（阈值调整 + 防挂机 + 改名瓜棚）
> 设计：小西
> 确认人：Charles Yu

## 设计背景

用户每次专注完成后获得收获物（小芽/幼苗/小花/小瓜/大西瓜），存入"瓜棚"。瓜棚里可以查看、合成收获物，给用户持续的目标感。

## 核心理念

1. **每次专注都有实质收获** — 收获物存入瓜棚，看得见摸得着
2. **合成是保底机制，不是主要路径** — 合成汇率故意不划算，鼓励更长专注
3. **隐藏款制造惊喜** — 61-90 分钟专注有概率开出金西瓜
4. **不鼓励过度专注** — 90 分钟封顶，>90 分钟不额外奖励
5. **防挂机** — 超过设定时间 2 倍不给奖励，>25 分钟强制手动结束

---

## 一、专注时长与收获物

| 收获物 | 专注时长 | 阶段 | 说明 |
|--------|---------|------|------|
| 🌱 小芽 | 5-15 分钟 | seed | 碎片专注，热身阶段 |
| 🌿 幼苗 | 16-25 分钟 | sprout | 接近标准番茄钟 |
| 🌼 小花 | 26-45 分钟 | bloom | 标准番茄钟区间，大多数用户主力时长 |
| 🍈 小瓜 | 46-60 分钟 | green | 深度专注 |
| 🍉 大西瓜 | 61-90 分钟 | ripe | 长时间深度工作 |
| 👑 金西瓜 | 61-90 分钟（10% 概率） | legendary | 隐藏款，随机惊喜 |
| 🍉 大西瓜 | >90 分钟 | ripe | 封顶，不额外奖励 |

**规则：**
- < 5 分钟不给收获物
- >90 分钟封顶为大西瓜，不触发金西瓜概率
- 收获物名称：小芽/幼苗/小花/小瓜/大西瓜/金西瓜（"种子"留给未来切瓜系统）

---

## 二、防挂机机制

### 规则 1：>25 分钟强制手动结束

- 设定 ≤25 分钟 → Auto-start Break 正常生效，时间到自动完成
- 设定 >25 分钟 → 强制关闭自动结束，必须手动点 Done
- UI 提示（当用户设定 >25 分钟时）："超过 25 分钟的专注建议手动结束，确保你适时休息 🧘"

### 规则 2：超时 2 倍不给奖励

- 必须在设定时间的 **2 倍**以内点 Done 才有收获物
- 例：设了 30 分钟 → 必须在 60 分钟内点 Done → 获得 30 分钟对应的小花
- 超过 60 分钟才点 → 没有收获物（视为挂机）

### 规则 3：奖励按设定时间算

- 收获物按**设定时间**计算，不按实际经过时间
- 设了 30 分钟，40 分钟才点 Done → 奖励按 30 分钟算（小花），不按 40 分钟算
- 防止"设短时间但拖着不点来刷更高奖励"

### 项目模式同理

- overtime 超过预估时间的 2 倍 → 不给收获物
- 奖励按预估时间算

---

## 三、隐藏款 — 金西瓜 👑

**触发条件：** 专注 61-90 分钟（不含 >90 分钟）

**概率：** 10%
- 没开出时：正常获得大西瓜 🍉（不亏）
- 开出时：获得金西瓜 👑 + 超级庆祝效果

**保底机制：** 连续 20 次 61-90 分钟专注未开出 → 第 21 次必出
- 保底计数器存在 localStorage
- 防止极端倒霉的用户永远开不出

**庆祝效果（比大西瓜更隆重）：**
- 背景：全屏金色爆炸 + 彩虹光效
- 收获物：金西瓜图标居中，金色粒子环绕旋转
- 前景：满屏金色礼花 + 钻石般闪光
- 持续时间：8 秒
- 文案："传说中的金西瓜！你是专注大师 👑"

---

## 四、瓜棚系统

### 入口
- 主界面 header 区域 🏠 图标按钮
- 点击打开瓜棚弹窗

### 瓜棚页面
- 标题：🏠 我的瓜棚 / My Melon Shed
- 6 种收获物网格展示（图标 + 名称 + 数量）
- 金西瓜未获得时显示 🔒 + "???"
- 统计：总收获数、最高阶收获物
- 合成区域

### 数据存储
- localStorage，key: `watermelon-warehouse`
- 数据结构：
```typescript
interface Warehouse {
  items: Record<GrowthStage, number>;
  legendaryPity: number;  // 保底计数器
  totalCollected: number; // 历史总收获数
}
```

---

## 五、合成系统

### 合成链路

| 合成方向 | 所需数量 | 产出 |
|---------|---------|------|
| 🌱 小芽 → 🌿 幼苗 | 20 个小芽 | 1 个幼苗 |
| 🌿 幼苗 → 🌼 小花 | 15 个幼苗 | 1 朵小花 |
| 🌼 小花 → 🍈 小瓜 | 10 朵小花 | 1 个小瓜 |
| 🍈 小瓜 → 🍉 大西瓜 | 5 个小瓜 | 1 个大西瓜 |

**规则：**
- 合成代价约为直接专注的 3-5 倍，明显不划算
- 金西瓜 👑 不可合成
- 合成只能手动触发（Charles 特别强调）

### 合成交互
- "合成"按钮 → 合成 1 个
- "合成全部"按钮 → 批量合成
- 数量不足时按钮置灰
- 合成动画 + Toast 提示

---

## 六、专注完成流程

```
专注完成（手动点 Done 或自动完成）
  ↓
检查防挂机：实际时间是否超过设定时间 2 倍？
  → 超过：不给收获物，直接进入休息
  → 未超过：继续
  ↓
按设定时间计算收获物阶段
  ↓
如果 61-90 分钟：
  → 10% 概率：获得金西瓜 👑（重置保底计数器）
  → 90% 概率：获得大西瓜 🍉（保底计数器 +1）
  → 如果保底计数器 ≥ 20：必出金西瓜 👑
  ↓
如果 >90 分钟：
  → 获得大西瓜 🍉（封顶，不触发金西瓜概率）
  ↓
收获物存入瓜棚（localStorage）
  ↓
播放庆祝动画（按阶段）
  ↓
进入休息
```

---

## 七、版本归属

v0.8.0 已实现：
- 瓜棚页面（展示 + 统计）
- 合成系统（4 条合成链路）
- 隐藏款金西瓜（概率 + 保底 + 庆祝效果）
- 收获物自动存入瓜棚
- 测试面板（设置页底部 🧪 Test Mode）

待实现（v0.8.x hotfix）：
- 阈值调整为新版（5-15/16-25/26-45/46-60/61-90）
- 金西瓜触发区间改为 61-90 分钟
- 防挂机机制（>25min 强制手动 + 超时 2 倍不给奖励 + 按设定时间算奖励）
